name: ğŸš€ Deploy Normalized Views

on:
  workflow_dispatch:

jobs:
  deploy-views:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“ Deploy Views to Supabase via SQL Proxy
        run: |
          echo "ğŸ“ Deploying views from /views folder..."
          for file in $(ls views/*.sql); do
            echo "ğŸš€ Deploying $file"
            curl -X POST "$SQL_PROXY_URL" \
              -H "Authorization: $SQL_PROXY_SECRET" \
              -H "Content-Type: application/json" \
              -d '{"sql_file":"'"$file"'", "sql_content":"'"$(cat "$file" | sed ':a;N;$!ba;s/\n/ /g')"'" }'
            echo ""
          done
        env:
          SQL_PROXY_URL: ${{ secrets.SQL_PROXY_URL }}
          SQL_PROXY_SECRET: ${{ secrets.SQL_PROXY_SECRET }}
