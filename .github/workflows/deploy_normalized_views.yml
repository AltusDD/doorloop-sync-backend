name: üöÄ Deploy Normalized Views via SQL Proxy

on:
  workflow_dispatch:

jobs:
  deploy-views:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: üîê Load environment variables
        run: |
          echo "${{ secrets.DOTENV_BUILD }}" > .env.build

      - name: üîÑ Deploy all SQL views via sql-proxy
        run: |
          echo "üìÅ Deploying views from /views folder..."
          for file in $(ls views/*.sql); do
            echo "üöÄ Deploying $file"
            curl -X POST "${{ secrets.SQL_PROXY_URL }}" \
              -H "Authorization: Bearer ${{ secrets.SQL_PROXY_SECRET }}" \
              -H "Content-Type: application/json" \
              -d '{{"sql_file":"'$file'", "sql_content":"'"$(cat $file | sed ':a;N;$!ba;s/\n/ /g')"'"}}'
            echo ""
          done
        env:
          SQL_PROXY_URL: ${{ secrets.SQL_PROXY_URL }}
          SQL_PROXY_SECRET: ${{ secrets.SQL_PROXY_SECRET }}