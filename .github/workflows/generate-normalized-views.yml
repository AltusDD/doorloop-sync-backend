name: Database View Generation

on: [push, pull_request]

jobs:
  generate-views:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psycopg2-binary

    - name: Run Network Diagnostics
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        python -c 'import socket, ssl
host = "db.ssexobxvtuxwnblwplzh.supabase.co"
port = 5432
print(f"Diagnosing {host}:{port}")
try:
    ip_addresses = socket.getaddrinfo(host, port, socket.AF_UNSPEC, socket.SOCK_STREAM)
    print(f"✅ DNS Resolution: {len(ip_addresses)} IPs found")
    for fam, st, pr, cn, sa in ip_addresses:
        try:
            with socket.create_connection((sa[0], port), timeout=5) as s:
                print(f"✅ TCP OK to {sa[0]}")
        except Exception as e:
            print(f"❌ TCP Fail to {sa[0]}: {e}")
    ctx = ssl.create_default_context()
    with socket.create_connection((host, port), timeout=5) as sock:
        with ctx.wrap_socket(sock, server_hostname=host) as ssock:
            print("✅ SSL OK")
except Exception as e:
    print(f"❌ NetDiag failed: {e}")'

    - name: Generate Normalized Views
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: python generate_normalized_views.py
