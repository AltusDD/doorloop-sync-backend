#!/bin/bash

echo "📦 Deploying SQL files via proxy to Supabase project: $PROJECT_REF"

SQL_DIR="./scripts"
echo "📁 Using SQL directory: $SQL_DIR"

for file in $(find "$SQL_DIR" -name "*.sql" | sort); do
  echo "🚀 Applying: $file"

  # Read the contents and escape it properly for JSON
  sql_content=$(jq -Rs . < "$file")

  # Send it to the Edge Function with the correct Authorization header
  response=$(curl -s -X POST "$SQL_PROXY_URL" \
    -H "Authorization: Bearer $SQL_PROXY_SECRET" \
    -H "Content-Type: application/json" \
    -d "{\"sql_file\": \"$(basename "$file")\", \"sql_content\": $sql_content}")

  # Check response
  if echo "$response" | grep -q "\"success\":true"; then
    echo "✅ Success: $(basename "$file")"
  else
    echo "❌ Failed: $(basename "$file")"
    echo "Response: $response"
    exit 1
  fi
done
