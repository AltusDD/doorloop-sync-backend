name: Deploy Normalized SQL via Proxy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'scripts/**/*.sql'
      - '.github/workflows/deploy-normalized-sql.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_REF: ${{ secrets.PROJECT_REF }}
      SQL_PROXY_SECRET: ${{ secrets.SQL_PROXY_SECRET }}
      SQL_PROXY_URL: ${{ secrets.SQL_PROXY_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq (required for JSON escaping)
        run: sudo apt-get install -y jq

      - name: Make script executable
        run: chmod +x ./deploy_all_sql_via_proxy.sh

      - name: Run SQL deploy via proxy
        run: ./deploy_all_sql_via_proxy.sh
