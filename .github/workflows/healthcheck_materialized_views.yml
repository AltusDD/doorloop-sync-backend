name: Materialized View Healthcheck

on:
  schedule:
    - cron: '30 8 * * *'  # 3:30AM EST
  workflow_dispatch:

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§¾ Checkout Repo
        uses: actions/checkout@v3

      - name: ðŸ˜ Install PostgreSQL Client
        run: sudo apt-get install postgresql-client -y

      - name: ðŸ” Parse DB URL into Components
        id: parse
        env:
          DBURL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "PGHOST=$(echo $DBURL | sed -E 's|.*@([^:/]+):.*||')" >> $GITHUB_ENV
          echo "PGPORT=$(echo $DBURL | sed -E 's|.*:([0-9]+)/.*||')" >> $GITHUB_ENV
          echo "PGDATABASE=$(echo $DBURL | sed -E 's|.*/([^?]+).*||')" >> $GITHUB_ENV
          echo "PGUSER=$(echo $DBURL | sed -E 's|.*//([^:]+):.*||')" >> $GITHUB_ENV
          echo "PGPASSWORD=$(echo $DBURL | sed -E 's|.*:([^@]+)@.*||')" >> $GITHUB_ENV

      - name: âœ… Run Healthcheck Queries
        run: |
          views=("get_full_properties_view" "get_full_units_view" "get_full_leases_view" "get_full_tenants_view" "get_full_work_orders_view")
          for v in "${views[@]}"; do
            echo "Checking $v..."
            psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -c "SELECT * FROM $v LIMIT 1;" || exit 1
          done
