name: 🚀 Normalize and Patch Data

on:
  workflow_dispatch:

jobs:
  normalize:
    name: 🚀 Normalize Data Job
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repo
        uses: actions/checkout@v3

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 🔧 Install Dependencies (Hardened)
        run: |
          echo "--- Python Version Info ---"
          which python
          python --version
          which pip
          pip --version

          echo "--- 🔥 Upgrade Pip ---"
          python -m pip install --upgrade pip

          echo "--- 🔥 Purge Pip Cache ---"
          pip cache purge

          echo "--- 🔩 Force Install psycopg2-binary ---"
          pip install --no-cache-dir --force-reinstall psycopg2-binary==2.9.9 -v

          echo "--- 📦 Install Other Dependencies ---"
          pip install --no-cache-dir -r requirements.txt -v

          echo "--- 📋 pip freeze ---"
          pip freeze

          echo "--- ✅ Import Test ---"
          python -c "import psycopg2; print('✅ psycopg2 installed and import successful!')" || exit 1

      - name: 🧠 Run Normalization Pipeline
        run: |
          python scripts/normalize_and_patch_all.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PYTHONPATH: .:${PYTHONPATH}
