name: ğŸš€ Normalize and Patch Data

on:
  workflow_dispatch:

jobs:
  normalize:
    name: ğŸš€ Normalize Data Job
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ”§ Install Dependencies (Hardened)
        run: |
          echo "--- Python Version Info ---"
          which python
          python --version
          which pip
          pip --version

          echo "--- ğŸ”¥ Upgrade Pip ---"
          python -m pip install --upgrade pip

          echo "--- ğŸ”¥ Purge Pip Cache ---"
          pip cache purge

          echo "--- ğŸ”© Force Install psycopg2-binary ---"
          pip install --no-cache-dir --force-reinstall psycopg2-binary==2.9.9 -v

          echo "--- ğŸ“¦ Install Other Dependencies ---"
          pip install --no-cache-dir -r requirements.txt -v

          echo "--- ğŸ“‹ pip freeze ---"
          pip freeze

          echo "--- âœ… Import Test ---"
          python -c "import psycopg2; print('âœ… psycopg2 installed and import successful!')" || exit 1

      - name: ğŸ§  Run Normalization Pipeline
        run: |
          python scripts/normalize_and_patch_all.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PYTHONPATH: .:${PYTHONPATH}
