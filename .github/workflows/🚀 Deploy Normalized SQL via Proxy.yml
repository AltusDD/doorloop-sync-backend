name: üöÄ Deploy Normalized SQL via Proxy

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/üöÄ Deploy Normalized SQL via Proxy.yml'
      - 'scripts/**/*.sql'
      - 'deploy_all_sql_via_proxy.sh'

jobs:
  deploy-sql:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      - name: üß∞ Set up jq
        run: sudo apt-get install jq -y

      - name: üöÄ Run SQL Deployment Script
        run: |
          echo "üì¶ Deploying SQL files via proxy to Supabase project: $PROJECT_REF"
          echo "üìÅ Using SQL directory: ./scripts"

          for file in ./scripts/*.sql; do
            filename=$(basename "$file")

            echo "üöÄ Applying: $filename"
            SQL_CONTENT=$(cat "$file" | jq -Rs .)

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$SQL_PROXY_URL" \
              -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
              -H "x-proxy-secret: $SQL_PROXY_SECRET" \
              -H "Content-Type: application/json" \
              -d "{"sql": $SQL_CONTENT}"
            )

            HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | sed '$ d')

            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "‚úÖ Success: $filename"
            else
              echo "‚ùå Failed: $filename (HTTP $HTTP_STATUS)"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
          done
        env:
          PROJECT_REF: ${{ secrets.PROJECT_REF }}
          SQL_PROXY_URL: ${{ secrets.SQL_PROXY_URL }}
          SQL_PROXY_SECRET: ${{ secrets.SQL_PROXY_SECRET }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
